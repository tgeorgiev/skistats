/*! skistats 15-04-2015 */
!function(a,b){"use strict";function c(a){this.mapObj=d3.select(a).append("div"),this.tooltip=d3.select(a).append("div").attr("class","mapTooltip"),this.mapPasses={},this.raphaelLifts={},this.raphaelPaper=new Raphael(this.mapObj[0][0],"100%","100%"),this.rootPoint=this.raphaelPaper.canvas.createSVGPoint(),g&&this.updateStrategy(),this.updatePasses()}function d(a){this.legendObj=d3.select(a).append("form").attr("class","liftLegend").on("submit",function(){return d3.event.preventDefault(),!1}).append("fieldset"),this.legendObj.append("legend").html("Lifts"),g&&this.updateStrategy()}function e(a){this.legendObj=d3.select(a).append("form").attr("class","passLegend").on("submit",function(){return d3.event.preventDefault(),!1}).append("fieldset"),this.updatePasses()}function f(a,b,c){var d=this.timelineContainer=d3.select(a).append("div").attr("class","timelineContainer");this.gantt=d3.gantt(),b&&this.gantt.viewport(b),c&&this.gantt.margin(c),this.gantt(d[0][0]),this.gantt.yTickFormatMapper(function(a){var b=p[a].displayName;return b||a});var e=this.lineHolder=d.append("div").attr("class","lineContainer");e.append("div").attr("class","lineTop"),e.append("div").attr("class","line"),e.append("div").attr("class","lineBottom"),this.lineLabel=e.append("div").attr("class","lineLabel"),g&&this.refresh(),this.updatePosition()}d3.gantt=function(){function a(c){b=d3.select(c);var d=(b[0][0],h.width-g.right-g.left-5),e=h.height-g.bottom-g.top-5,f=b.append("svg").attr("class","chart").attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+h.width+" "+h.height).attr("preserveAspectRatio","xMidYMid").append("g").attr("class","gantt-chart").attr("transform","translate("+g.left+", "+g.top+")");return f.append("g").attr("class","x axis"),f.append("g").attr("class","y axis"),n.range([0,d]),o.rangeRoundBands([0,e],.1),a.getChartGroup().select(".x.axis").attr("transform","translate(0, "+e+")").transition().call(p),a.getChartGroup().select(".y.axis").transition().call(q),a}var b,c,d,e,f,g={top:0,right:0,bottom:25,left:0},h={width:1200,height:150},i=[],j=[],k="%d/%m/%Y %H:%M",l=function(a){return a.startDate+a.taskName+a.endDate},m=function(a){return"translate("+n(a.startDate)+","+o(a.taskName)+")"},n=d3.time.scale().clamp(!0),o=d3.scale.ordinal(),p=d3.svg.axis().scale(n).orient("bottom").tickFormat(d3.time.format(k)).tickSubdivide(!0).tickSize(8).tickPadding(4).ticks(6),q=d3.svg.axis().scale(o).orient("right").tickSize(0);return a.getContainer=function(){return b},a.getChart=function(){return b.select(".chart")},a.getChartGroup=function(){return a.getChart().select(".gantt-chart")},a.getX=function(){return n},a.getXAxis=function(){return p},a.redraw=function(b,c){b&&(e=b);var d=a.getChartGroup().selectAll("rect").data(e,l);return d.enter().insert("rect",".axis").attr("rx",5).attr("ry",5).attr("stroke",function(a){return j[a.status]?j[a.status]:""}).attr("fill",function(a){return j[a.status]?j[a.status]:""}).transition().attr("y",0).attr("transform",m).attr("height",function(a){return o.rangeBand()}).attr("width",function(a){return n(a.endDate)-n(a.startDate)}),d.attr("transform",m).attr("height",function(a){return o.rangeBand()}).attr("width",function(a){return n(a.endDate)-n(a.startDate)}),d.exit().remove(),a.updateXAxis(c),a.updateYAxis(c),a},a.margin=function(b){return arguments.length?(g=b,a):g},a.viewport=function(b){return arguments.length?(h=b,a):h},a.timeDomain=function(b){return arguments.length?(c=+b[0],d=+b[1],n.domain([c,d]),a):[c,d]},a.taskTypes=function(b){return arguments.length?(i=b,o.domain(i),a):i},a.taskStatusColor=function(b){return arguments.length?(j=b,a):j},a.tickFormat=function(b){return arguments.length?(k=b,p.tickFormat(d3.time.format(k)),a.updateXAxis(),a):k},a.yTickFormatMapper=function(b){return arguments.length?(f=b,q.tickFormat(f),a.updateYAxis(),a):f},a.updateXAxis=function(b){var c=a.getChartGroup().select(".x.axis");b&&c.transition(),c.call(p)},a.updateYAxis=function(b){var c=a.getChartGroup().select(".y.axis");b&&c.transition(),c.call(q)},a};var g,h,i,j,k,l="%d/%m/%Y %H:%M",m=d3.time.format(l),n=d3.scale.category10(),o="",p={},q=[],r=d3.dispatch("zoom"),s=10,t=s/2,u=4,v="CSV_STAT_MODE",w="JSON_STAT_MODE";c.prototype.updateStrategy=function(){var a=g.mapUrl;-1==a.indexOf("http://")&&-1==a.indexOf("https://")&&(a=o+a),this.mapObj.style("background-image","url("+a+")").style("background-size","contain").style("height","100%").style("background-repeat","no-repeat").style("background-position","50% 0%"),this.raphaelPaper.setViewBox(0,0,g.viewport.width,g.viewport.height,!1),this.raphaelPaper.canvas.setAttribute("preserveAspectRatio","xMidYMin");var b=function(){this.attr("stroke-width","8px").attr("stroke-opacity","0.8");var a=this[0].getBoundingClientRect(),b=this.data("lift");h.tooltip.style("display","block").html(b.displayName).style("left",a.left+"px").style("top",a.top+"px")},c=function(){this.attr("stroke-width","6px").attr("stroke-opacity","0.8"),h.tooltip.style("display","none")};for(var d in g.liftPaths){var e=g.liftPaths[d],f=e.path,i=this.raphaelPaper.path(f);i.attr("stroke",e.color).attr("stroke-width","6px").attr("stroke-opacity","0.8"),i.data("lift",e),i.mouseover(b),i.mouseout(c),this.raphaelLifts[d]=i}},c.prototype.updatePosition=function(a){var b=[];for(var c in p){var d=this.mapPasses[c],e=D(c,a);if(e){d.show();var f,g,h=(a-e.startDate)/(e.endDate-e.startDate),i=this.raphaelLifts[e.lift],j=i.getTotalLength(),k=i.getPointAtLength(h*j);h+.01>1?(f=i.getPointAtLength((h-.01)*j),g=k):(f=k,g=i.getPointAtLength((h+.01)*j));var l=Raphael.angle(f.x,f.y,g.x,g.y);b.push({circle:d,point:k,angle:l})}else d.hide()}var m=x(b);y(m)};var x=function(a){var b=[];a.sort(function(a,b){return z(a.point,b.point)-t});for(var c=0;c<a.length;c++){for(var d=a[c],e=!1,f=0;f<b.length;f++){var g=b[f];if(!e&&Math.pow(d.point.x-g.area.center.x,2)+Math.pow(d.point.y-g.area.center.y,2)<Math.pow(g.area.radius,2)){var h=z(d.point,g.area.center);g.area.radius=Math.max(g.area.radius,h+t),g.cwps.push(d),e=!0}}e||b.push({area:{center:d.point,radius:t},cwps:[d]})}return b},y=function(a){for(var b=0;b<a.length;b++)for(var c,d=a[b].cwps,e=(d.length-1)/2,f=0;f<d.length;f++){var g=d[f],h=g.point,i=g.angle;0>f-e?i=g.angle-90:f-e>0&&(i=g.angle+90);var j=i*(Math.PI/180),k=Math.abs(t*(f-e));h.x+=k*Math.cos(j),h.y+=k*Math.sin(j),g.circle.transform("t"+[h.x,h.y]),c&&g.circle.insertAfter(c.circle),c=g}},z=function(a,b){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))};c.prototype.updatePasses=function(){var a=function(){this.attr("r","12");var a=this[0].getBoundingClientRect(),b=this.data("stat");h.tooltip.style("display","block").html(b.displayName).style("left",a.left+a.width+u+"px").style("top",a.top+"px")},b=function(){this.attr("r","10"),h.tooltip.style("display","none")},c=0;for(var d in p){var e=this.raphaelPaper.circle(0,0,s).attr("fill",n(c));e.mouseover(a),e.mouseout(b),e.data("stat",p[d]),e.hide(),this.mapPasses[d]=e,c++}},d.prototype.updateStrategy=function(){this.legendObj.html(""),this.legendObj.append("legend").html("Lifts");for(var a in g.liftPaths){var b=g.liftPaths[a],c=this.legendObj.append("div");c.append("div").attr("class","liftPath").style("border-color",g.liftPaths[a].color),c.append("div").attr("class","liftName").html(b.displayName)}},e.prototype.updatePasses=function(){this.legendObj.html(""),this.legendObj.append("legend").html("Passes");var a=0;for(var b in p){var c=p[b],d=c.displayName,e=this.legendObj.append("div");e.append("div").attr("class","passColor").style("border-color",n(a));var f=e.append("span").attr("class","passName").html(d),g=e.append("input").attr("class","passNameEdit").style("display","none");A(f,g,c),a++}};var A=function(a,b,c){a.on("click",function(){var d=a[0][0].offsetWidth;a.style("display","none"),b.style("display","").style("width",d+"px");var e=b[0][0];e.value=c.displayName,e.focus(),e.setSelectionRange(0,e.value.length)});var d=function(){var d=b[0][0],e=d.value;b.style("display","none"),a.style("display","").html(e),c.displayName=e,k&&k.updateYTickFormat()};b.on("blur",d),b.on("keypress",function(){13==d3.event.keyCode&&d()})};f.prototype.refresh=function(){var a,b,c=0,d=[],e=[];for(var f in p){var g=p[f];d.push(g.displayName);for(var h=0;h<g.entries.length;h++){var i=g.entries[h];e.push({startDate:i.startDate,endDate:i.endDate,taskName:f,status:i.lift}),a?a-i.startDate>0&&(a=i.startDate):a=i.startDate,b?i.endDate-b>0&&(b=i.endDate):b=i.endDate}c++}this.tasks=e,this.gantt.taskTypes(d),this.gantt.taskStatusColor(C());var j=new Date(a.getTime()-(b.getTime()-a.getTime())),k=new Date(b.getTime()+(b.getTime()-a.getTime()));this.gantt.timeDomain([j,k]);var l=this.gantt,m=this;this.zoom=d3.behavior.zoom().x(l.getX()).scaleExtent([1,200]).on("zoom",function(){l.redraw(e),m.updatePosition(),r.zoom(m.zoom.scale())}),this.zoom.scale(1.5),this.zoom(l.getChart()),this.gantt.redraw(e,!0)},f.prototype.updateYTickFormat=function(){this.gantt.updateYAxis()},f.prototype.updatePosition=function(){var a=this.gantt.margin().left,b=this.gantt.viewport().width/this.timelineContainer[0][0].offsetWidth,c=this.lineHolder[0][0].offsetLeft*b-a,d=this.gantt.getX().invert(c),e=m(d);this.lineLabel.html(e),h&&h.updatePosition(d)},f.prototype.zoomCentered=function(a){var b=this.zoom.translate()[0],c=this.zoom.scale(),d=this.gantt.viewport().width*(a/c),e=(d-this.gantt.viewport().width)/2,f=b*(a/c),g=f-e;this.zoom.translate([g,0]),this.zoom.scale(a),r.zoom(this.zoom.scale()),this.gantt.redraw(this.tasks)},f.prototype.zoomIntervalMs=function(a){var b=this.zoom.scale(),c=this.gantt.getX().invert(0),d=this.gantt.getX().invert(this.gantt.viewport().width),e=(d-c)/a;this.zoomCentered(b*e)};var B=function(a){g=a,h&&h.updateStrategy(),i&&i.updateStrategy()},C=function(){var a=g.liftPaths,b={};for(var c in a)b[c]=a[c].color;return b},D=function(a,b){for(var c=p[a],d=0;d<c.entries.length;d++){var e=c.entries[d];if(e.startDate<b&&b<e.endDate)return e}return null},E=function(a,b,c){return c==v?a.recognizeCSV&&a.recognizeCSV(b):a.recognizeJSON&&a.recognizeJSON(b)},F=function(a,b){if(g){if(!E(g,a,b))throw new Error("There was already a selected strategy [ "+g.name+"] but it does not recognize new contents. Make sure the files follow the same format.");return g}for(var c=[],d=0;d<q.length;d++){var e=q[d];E(e,a,b)&&c.push(e)}if(0===c.length)throw new Error("No applicable strategies found!");if(c.length>1)throw new Error(c.length+" applicable strategies were found, only one was expected. "+c);return c[0]},G={},H=function(a,b,c){g||B(F(b,c));var d;d=c===v?g.retrieveEntriesCSV(b):g.retrieveEntriesJSON(b),p[a]={displayName:a,entries:d},h&&h.updatePasses(),j&&j.updatePasses()};G.addCSV=function(a,b){H(a,b,v)},G.addJSON=function(a,b){H(a,b,w)},G.registerStrategy=function(a){q.push(a)},G.map=function(a){if(h)throw new Error("Only single instance of the map is supported");h=new c(a)},G.liftLegend=function(a){if(i)throw new Error("Only single instance of the lift legend is supported");i=new d(a)},G.passLegend=function(a){if(j)throw new Error("Only single instance of the pass legend is supported");j=new e(a)};var I={};I.getZoomScaleExtent=function(){return k.zoom.scaleExtent()},I.getZoomContext=function(){return k?{scale:k.zoom.scale()}:void 0},I.zoomCentered=function(a){k&&k.zoomCentered(a)},I.zoomIntervalMs=function(a){k&&k.zoomIntervalMs(a)},I.onZoom=function(a){r.on("zoom",a)},G.timeline=function(a,b,c){if(k)throw new Error("Only single instance of the timeline is supported");return k=new f(a,b,c),I},G.dateFormat=function(a){return arguments.length?(l=a,m=d3.time.format(l),G):l},G.strategyBaseUrl=function(a){return arguments.length?(h&&console.warn("Map was already initialized, strategyBaseUrl will not be applied."),o=a,G):o},G.selectedSkiStrategy=function(){return g},G.VERSION="0.0.1",a.skistats=G}(this);