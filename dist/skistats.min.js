/*! skistats 06-04-2015 */
!function(a,b){"use strict";function c(a){this.mapObj=d3.select(a).append("div"),this.mapActors={},this.raphaelLifts={},this.raphaelPaper=new Raphael(this.mapObj[0][0],"100%","100%"),h&&this.updateStrategy(),this.updateActors()}function d(a){this.legendObj=d3.select(a).append("form").attr("class","liftLegend").append("fieldset"),this.legendObj.append("legend").html("Lifts"),h&&this.updateStrategy()}function e(a){this.legendObj=d3.select(a).append("form").attr("class","participantsLegend").append("fieldset"),this.legendObj.append("legend").html("Participants"),this.updateActors()}function f(a){this.gantt=d3.gantt()(a),this.gantt.yTickFormatMapper(function(a){var b=p[a].displayName;return b||a}),h&&this.refresh()}function g(a){var b=this.lineHolder=d3.select(a).append("div").attr("class","lineContainer");b.append("div").attr("class","lineTop"),b.append("div").attr("class","line"),b.append("div").attr("class","lineBottom"),this.lineLabel=b.append("div").attr("class","lineLabel"),this.updatePosition()}d3.gantt=function(){function a(c){b=d3.select(c);var d=(b[0][0],g.width),e=g.height,f=d-g.right-g.left-5,h=e-g.bottom-g.top-5,i=b.append("svg").attr("class","chart").attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+d+" "+e).attr("preserveAspectRatio","xMidYMid").append("g").attr("class","gantt-chart").attr("transform","translate("+g.left+", "+g.top+")");return i.append("g").attr("class","x axis"),i.append("g").attr("class","y axis"),m.range([0,f]),n.rangeRoundBands([0,h],.1),a.getChartGroup().select(".x.axis").attr("transform","translate(0, "+h+")").transition().call(o),a.getChartGroup().select(".y.axis").transition().call(p),a}var b,c,d,e,f,g={top:0,right:0,bottom:25,left:0,width:1200,height:150},h=[],i=[],j="%d/%m/%Y %H:%M:%S",k=function(a){return a.startDate+a.taskName+a.endDate},l=function(a){return"translate("+m(a.startDate)+","+n(a.taskName)+")"},m=d3.time.scale().clamp(!0),n=d3.scale.ordinal(),o=d3.svg.axis().scale(m).orient("bottom").tickFormat(d3.time.format(j)).tickSubdivide(!0).tickSize(8).tickPadding(8),p=d3.svg.axis().scale(n).orient("right").tickSize(0);return a.getContainer=function(){return b},a.getChart=function(){return b.select(".chart")},a.getChartGroup=function(){return a.getChart().select(".gantt-chart")},a.getX=function(){return m},a.getXAxis=function(){return o},a.redraw=function(b,c){b&&(e=b);var d=a.getChartGroup().selectAll("rect").data(e,k);return d.enter().insert("rect",".axis").attr("rx",5).attr("ry",5).attr("stroke",function(a){return i[a.status]?i[a.status]:""}).attr("fill",function(a){return i[a.status]?i[a.status]:""}).transition().attr("y",0).attr("transform",l).attr("height",function(a){return n.rangeBand()}).attr("width",function(a){return m(a.endDate)-m(a.startDate)}),d.attr("transform",l).attr("height",function(a){return n.rangeBand()}).attr("width",function(a){return m(a.endDate)-m(a.startDate)}),d.exit().remove(),a.updateXAxis(c),a.updateYAxis(c),a},a.margin=function(b){return arguments.length?(g=b,a):g},a.timeDomain=function(b){return arguments.length?(c=+b[0],d=+b[1],m.domain([c,d]),a):[c,d]},a.taskTypes=function(b){return arguments.length?(h=b,n.domain(h),a):h},a.taskStatusColor=function(b){return arguments.length?(i=b,a):i},a.tickFormat=function(b){return arguments.length?(j=b,o.tickFormat(d3.time.format(j)),a.updateXAxis(),a):j},a.yTickFormatMapper=function(b){return arguments.length?(f=b,p.tickFormat(f),a.updateYAxis(),a):f},a.updateXAxis=function(b){var c=a.getChartGroup().select(".x.axis");b&&c.transition(),c.call(o)},a.updateYAxis=function(b){var c=a.getChartGroup().select(".y.axis");b&&c.transition(),c.call(p)},a};var h,i,j,k,l,m,n="%d/%m/%Y %H:%M",o=d3.time.format(n),p={},q=[];c.prototype.updateStrategy=function(){this.mapObj.style("background-image","url("+h.mapUrl+")").style("background-size","contain").style("height","100%").style("background-repeat","no-repeat").style("background-position","50% 0%"),this.raphaelPaper.setViewBox(0,0,h.optimalWidth,h.optimalHeight,!1),this.raphaelPaper.canvas.setAttribute("preserveAspectRatio","xMidYMin");for(var a in h.liftPaths){var b=h.liftPaths[a],c=b.path,d=this.raphaelPaper.path(c);d.attr("stroke",b.color).attr("stroke-width","6px").attr("stroke-opacity","0.8"),this.raphaelLifts[a]=d}},c.prototype.updatePosition=function(a){for(var b in p){var c=this.mapActors[b],d=t(b,a);if(d){c.show();var e=(a-d.startDate)/(d.endDate-d.startDate);console.log("position "+e);var f=this.raphaelLifts[d.lift],g=f.getTotalLength(),h=f.getPointAtLength(e*g);c.transform("t"+[h.x,h.y])}else c.hide()}},c.prototype.updateActors=function(){for(var a in p){var b=this.raphaelPaper.circle(0,0,10).attr("fill","red");b.hide(),this.mapActors[a]=b}},d.prototype.updateStrategy=function(){this.legendObj.html(""),this.legendObj.append("legend").html("Lifts");for(var a in h.liftPaths){var b=this.legendObj.append("div");b.append("div").attr("class","liftPath").style("border-color",h.liftColors[a]),b.append("div").attr("class","liftName").html(a)}},e.prototype.updateActors=function(){this.legendObj.html(""),this.legendObj.append("legend").html("Participants");for(var a in p){var b=p[a],c=b.displayName,d=this.legendObj.append("div");d.append("div").attr("class","participantColor").style("border-color","green");var e=d.append("span").attr("class","participantName").html(c),f=d.append("input").attr("class","participantNameEdit").style("display","none");r(e,f,b)}};var r=function(a,b,c){a.on("click",function(){var d=a[0][0].offsetWidth;a.style("display","none"),b.style("display","").style("width",d+"px");var e=b[0][0];e.value=c.displayName,e.focus()});var d=function(){var d=b[0][0],e=d.value;b.style("display","none"),a.style("display","").html(e),c.displayName=e,l&&l.updateYTickFormat()};b.on("blur",d),b.on("keypress",function(){13==d3.event.keyCode&&d()})};f.prototype.refresh=function(){var a,b,c=0,d=[],e=[];for(var f in p){var g=p[f];d.push(g.displayName);for(var i=0;i<g.entries.length;i++){var j=g.entries[i];e.push({startDate:j.startDate,endDate:j.endDate,taskName:g.displayName,status:j.lift}),a?a-j.startDate>0&&(a=j.startDate):a=j.startDate,b?j.endDate-b>0&&(b=j.endDate):b=j.endDate}c++}this.gantt.taskTypes(d),this.gantt.taskStatusColor(h.liftColors);var k=new Date(a.getTime()-(b.getTime()-a.getTime())),l=new Date(b.getTime()+(b.getTime()-a.getTime()));this.gantt.timeDomain([k,l]);var n=this.gantt,o=d3.behavior.zoom().x(n.getX()).scaleExtent([1,200]).on("zoom",function(){n.redraw(e),m.updatePosition()});o.scale(1.5),o(n.getChart()),this.gantt.redraw(e,!0)},f.prototype.updateYTickFormat=function(){this.gantt.updateYAxis()},g.prototype.updatePosition=function(){var a=l.gantt,b=a.margin().left,c=a.margin().width/a.getChart()[0][0].offsetWidth,d=this.lineHolder[0][0].offsetLeft*c-b,e=a.getX().invert(d);this.updateLabel(e),i&&i.updatePosition(e)},g.prototype.updateLabel=function(a){var b=o(a);this.lineLabel.html(b)};var s=function(a){h=a,i&&i.updateStrategy(),j&&j.updateStrategy()},t=function(a,b){for(var c=p[a],d=0;d<c.entries.length;d++){var e=c.entries[d];if(e.startDate<b&&b<e.endDate)return e}return null},u=function(a){if(h){if(!h.recognize(a))throw new Error("There was already a selected strategy [ "+h.name+"] but it does not recognize new contents. Make sure the files follow the same format.");return h}for(var b=[],c=0;c<q.length;c++){var d=q[c];d.recognize(a)&&b.push(d)}if(0===b.length)throw new Error("No applicable strategies found!");if(b.length>1)throw new Error(b.length+" applicable strategies were found, only one was expected. "+b);return h=b[0]},v={};v.addStat=function(a,b){h||s(u(b));var c=h.retrieveEntries(b);p[a]={displayName:a,entries:c},i&&i.updateActors(),k&&k.updateActors()},v.addStrategy=function(a){q.push(a)},v.withMap=function(a){if(i)throw new Error("Only single instance of the map is supported");return i=new c(a),v},v.withLiftLegend=function(a){if(j)throw new Error("Only single instance of the lift legend is supported");return j=new d(a),v},v.withParticipantsLegend=function(a){if(k)throw new Error("Only single instance of the participants legend is supported");return k=new e(a),v},v.withTimeline=function(a){if(l)throw new Error("Only single instance of the timeline is supported");return l=new f(a),m=new g(a),v},v.dateFormat=function(a){return arguments.length?(n=a,o=d3.time.format(n),v):n},v.VERSION="0.0.1",a.skistats=v}(this);